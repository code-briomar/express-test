//   ______               __      __                                     _______             __
//   /      \             |  \    |  \                                   |       \           |  \
//  |  $$$$$$\ __    __  _| $$_   | $$____    ______    ______  __       | $$$$$$$\  ______   \$$  ______   ______ ____    ______    ______
//  | $$__| $$|  \  |  \|   $$ \  | $$    \  /      \  /      \|  \      | $$__/ $$ /      \ |  \ /      \ |      \    \  |      \  /      \
//  | $$    $$| $$  | $$ \$$$$$$  | $$$$$$$\|  $$$$$$\|  $$$$$$\\$$      | $$    $$|  $$$$$$\| $$|  $$$$$$\| $$$$$$\$$$$\  \$$$$$$\|  $$$$$$\
//  | $$$$$$$$| $$  | $$  | $$ __ | $$  | $$| $$  | $$| $$   \$$__       | $$$$$$$\| $$   \$$| $$| $$  | $$| $$ | $$ | $$ /      $$| $$   \$$
//  | $$  | $$| $$__/ $$  | $$|  \| $$  | $$| $$__/ $$| $$     |  \      | $$__/ $$| $$      | $$| $$__/ $$| $$ | $$ | $$|  $$$$$$$| $$
//  | $$  | $$ \$$    $$   \$$  $$| $$  | $$ \$$    $$| $$      \$$      | $$    $$| $$      | $$ \$$    $$| $$ | $$ | $$ \$$    $$| $$
//   \$$   \$$  \$$$$$$     \$$$$  \$$   \$$  \$$$$$$  \$$                \$$$$$$$  \$$       \$$  \$$$$$$  \$$  \$$  \$$  \$$$$$$$ \$$

//    ______   __    __      __    __            __                  __         __      __                                    __   __          __    __      __                  __                                                   __                          __                    __                  __
//   /      \ |  \  |  \    |  \  |  \          |  \                |  \       |  \    |  \                                  /  \ /  \        |  \  |  \    |  \                |  \                                                 /  \                        |  \                  |  \                |  \
//  |  $$$$$$\ \$$ _| $$_   | $$  | $$ __    __ | $$____   __       | $$____  _| $$_  _| $$_     ______    _______  __      /  $$/  $$______   \$$ _| $$_   | $$____   __    __ | $$____       _______   ______   ______ ____       /  $$_______   ______    ____| $$  ______          | $$____    ______   \$$  ______   ______ ____    ______    ______
//  | $$ __\$$|  \|   $$ \  | $$__| $$|  \  |  \| $$    \ |  \      | $$    \|   $$ \|   $$ \   /      \  /       \|  \    /  $$/  $$/      \ |  \|   $$ \  | $$    \ |  \  |  \| $$    \     /       \ /      \ |      \    \     /  $$/       \ /      \  /      $$ /      \  ______ | $$    \  /      \ |  \ /      \ |      \    \  |      \  /      \
//  | $$|    \| $$ \$$$$$$  | $$    $$| $$  | $$| $$$$$$$\ \$$      | $$$$$$$\\$$$$$$ \$$$$$$  |  $$$$$$\|  $$$$$$$ \$$   /  $$/  $$|  $$$$$$\| $$ \$$$$$$  | $$$$$$$\| $$  | $$| $$$$$$$\   |  $$$$$$$|  $$$$$$\| $$$$$$\$$$$\   /  $$|  $$$$$$$|  $$$$$$\|  $$$$$$$|  $$$$$$\|      \| $$$$$$$\|  $$$$$$\| $$|  $$$$$$\| $$$$$$\$$$$\  \$$$$$$\|  $$$$$$\
//  | $$ \$$$$| $$  | $$ __ | $$$$$$$$| $$  | $$| $$  | $$ __       | $$  | $$ | $$ __ | $$ __ | $$  | $$ \$$    \  __   /  $$/  $$ | $$  | $$| $$  | $$ __ | $$  | $$| $$  | $$| $$  | $$   | $$      | $$  | $$| $$ | $$ | $$  /  $$ | $$      | $$  | $$| $$  | $$| $$    $$ \$$$$$$| $$  | $$| $$   \$$| $$| $$  | $$| $$ | $$ | $$ /      $$| $$   \$$
//  | $$__| $$| $$  | $$|  \| $$  | $$| $$__/ $$| $$__/ $$|  \      | $$  | $$ | $$|  \| $$|  \| $$__/ $$ _\$$$$$$\|  \ /  $$/  $$  | $$__| $$| $$  | $$|  \| $$  | $$| $$__/ $$| $$__/ $$ __| $$_____ | $$__/ $$| $$ | $$ | $$ /  $$  | $$_____ | $$__/ $$| $$__| $$| $$$$$$$$        | $$__/ $$| $$      | $$| $$__/ $$| $$ | $$ | $$|  $$$$$$$| $$
//   \$$    $$| $$   \$$  $$| $$  | $$ \$$    $$| $$    $$ \$$      | $$  | $$  \$$  $$ \$$  $$| $$    $$|       $$ \$$|  $$|  $$    \$$    $$| $$   \$$  $$| $$  | $$ \$$    $$| $$    $$|  \\$$     \ \$$    $$| $$ | $$ | $$|  $$    \$$     \ \$$    $$ \$$    $$ \$$     \        | $$    $$| $$      | $$ \$$    $$| $$ | $$ | $$ \$$    $$| $$
//    \$$$$$$  \$$    \$$$$  \$$   \$$  \$$$$$$  \$$$$$$$            \$$   \$$   \$$$$   \$$$$ | $$$$$$$  \$$$$$$$      \$$  \$$     _\$$$$$$$ \$$    \$$$$  \$$   \$$  \$$$$$$  \$$$$$$$  \$$ \$$$$$$$  \$$$$$$  \$$  \$$  \$$ \$$      \$$$$$$$  \$$$$$$   \$$$$$$$  \$$$$$$$         \$$$$$$$  \$$       \$$  \$$$$$$  \$$  \$$  \$$  \$$$$$$$ \$$
//                                                                                             | $$                                 |  \__| $$
//                                                                                             | $$                                  \$$    $$
//                                                                                              \$$                                   \$$$$$$
//   _______                                                     __                                               ______                   __
//  |       \                                                   |  \                                             /      \                 |  \
//  | $$$$$$$\  ______    ______       __   ______    _______  _| $$_    __         _______   ______   _______  |  $$$$$$\  ______    ____| $$  ______
//  | $$__/ $$ /      \  /      \     |  \ /      \  /       \|   $$ \  |  \       /       \ |      \ |       \ | $$   \$$ /      \  /      $$ /      \
//  | $$    $$|  $$$$$$\|  $$$$$$\     \$$|  $$$$$$\|  $$$$$$$ \$$$$$$   \$$      |  $$$$$$$  \$$$$$$\| $$$$$$$\| $$      |  $$$$$$\|  $$$$$$$|  $$$$$$\
//  | $$$$$$$ | $$   \$$| $$  | $$    |  \| $$    $$| $$        | $$ __  __        \$$    \  /      $$| $$  | $$| $$   __ | $$  | $$| $$  | $$| $$    $$
//  | $$      | $$      | $$__/ $$    | $$| $$$$$$$$| $$_____   | $$|  \|  \       _\$$$$$$\|  $$$$$$$| $$  | $$| $$__/  \| $$__/ $$| $$__| $$| $$$$$$$$
//  | $$      | $$       \$$    $$    | $$ \$$     \ \$$     \   \$$  $$ \$$      |       $$ \$$    $$| $$  | $$ \$$    $$ \$$    $$ \$$    $$ \$$     \
//   \$$       \$$        \$$$$$$__   | $$  \$$$$$$$  \$$$$$$$    \$$$$            \$$$$$$$   \$$$$$$$ \$$   \$$  \$$$$$$   \$$$$$$   \$$$$$$$  \$$$$$$$
//                              |  \__/ $$
//                               \$$    $$
//                                \$$$$$$
//   _______              __                          ________              __        ________              __         ______    ______    ______   __    __
//  |       \            |  \                        |        \            /  \      |        \            /  \       /      \  /      \  /      \ |  \  |  \
//  | $$$$$$$\  ______  _| $$_     ______   __        \$$$$$$$$           /  $$       \$$$$$$$$           /  $$      |  $$$$$$\|  $$$$$$\|  $$$$$$\| $$  | $$
//  | $$  | $$ |      \|   $$ \   /      \ |  \          /  $$           /  $$           /  $$           /  $$        \$$__| $$| $$$\| $$ \$$__| $$| $$__| $$
//  | $$  | $$  \$$$$$$\\$$$$$$  |  $$$$$$\ \$$         /  $$           /  $$           /  $$           /  $$         /      $$| $$$$\ $$ /      $$| $$    $$
//  | $$  | $$ /      $$ | $$ __ | $$    $$ __         /  $$           /  $$           /  $$           /  $$         |  $$$$$$ | $$\$$\$$|  $$$$$$  \$$$$$$$$
//  | $$__/ $$|  $$$$$$$ | $$|  \| $$$$$$$$|  \       /  $$           /  $$           /  $$           /  $$          | $$_____ | $$_\$$$$| $$_____       | $$
//  | $$    $$ \$$    $$  \$$  $$ \$$     \ \$$      |  $$           |  $$           |  $$           |  $$           | $$     \ \$$  \$$$| $$     \      | $$
//   \$$$$$$$   \$$$$$$$   \$$$$   \$$$$$$$           \$$             \$$             \$$             \$$             \$$$$$$$$  \$$$$$$  \$$$$$$$$       \$$

import bodyParser from "body-parser";
import cors from "cors";
import fs from "fs";
import sanCodeBackendRoutes from "./routes/sanCodeBackendRoutes.js";
import { KEYS } from "./config/keys.js";
import path from "path";
import morgan from "morgan";
import moment from "moment-timezone";
import express from "express";

export const app = express();

app.use(cors());
app.use(express.json());
app.use(bodyParser.json());

const startOfToday = moment().format("dddd_Do_MMMM_YYYY");
const accessLogStream = fs.createWriteStream(
  path.join(KEYS.LOG_DIR, `${startOfToday}.log`),
  { flags: "a" }
);
app.use(morgan("combined", { stream: accessLogStream }));

// Error handling middleware
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).send({
    status: "500",
    message: "Internal server error",
    solution: "Please contact the administrator",
  });
});
app.use("/", sanCodeBackendRoutes);

app.listen(KEYS.PORT, () => {
  const dir = `${KEYS.HOME}/Desktop/sanCode-Excel-Summaries`;
  if (!fs.existsSync(dir)) {
    fs.mkdirSync(dir, { recursive: true });
  }

  fs.access(dir, fs.constants.W_OK, (err) => {
    if (err) {
      console.error("No write permission");
    }
  });

  //Create logs folder
  const logsFolder = "logs";
  if (!fs.existsSync(logsFolder)) {
    fs.mkdirSync(logsFolder, { recursive: true });
  }

  fs.writeFile(`./logs/${startOfToday}.log`, "", (err) => {
    if (err) {
      console.log(err);
    }
  });

  console.log(`Listening on Port ${KEYS.PORT}`);
});
